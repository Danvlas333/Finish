<!-- templates/markers_view.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Карта с маркерами изменений</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        #canvas-container {
            position: relative;
            max-width: 100vw;
            max-height: 100vh;
        }
        #canvas {
            display: block;
            cursor: pointer;
            max-width: 100%;
            max-height: 100vh;
        }
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            pointer-events: none;
            z-index: 1000;
            display: none;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            border: 1px solid #0a0;
            top: 0;
            left: 0;
        }
        #tooltip strong {
            color: #fff;
            display: block;
            margin-bottom: 4px;
        }
        #tooltip em {
            color: #afa;
            font-style: normal;
        }
        .loading {
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <canvas id="canvas"></canvas>
        <div id="tooltip"></div>
        <div id="loading" class="loading">Загрузка изображения...</div>
    </div>

    <script>
        // Данные передаются напрямую из Flask — без AJAX!
        const imageSrc = "{{ image_url }}";
        const records = {{ records | tojson }};
        const MAX_DISPLAY_WIDTH = 2000;

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        const loading = document.getElementById('loading');

        const BASE_RADIUS = 12;
        const HOVER_RADIUS = 18;
        const DETECTION_RADIUS = HOVER_RADIUS + 10;

        let scale = 1;
        let originalWidth, originalHeight;
        let hoveredIndex = -1;
        let imgLoaded = false;

        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
            originalWidth = img.width;
            originalHeight = img.height;

            if (img.width > MAX_DISPLAY_WIDTH) {
                scale = MAX_DISPLAY_WIDTH / img.width;
            } else {
                scale = 1;
            }

            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            imgLoaded = true;
            loading.style.display = 'none';

            drawMarkers();
        };
        img.src = imageSrc;

        function drawMarkers() {
            if (!imgLoaded) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            records.forEach((rec, idx) => {
                const x = rec.x * scale;
                const y = rec.y * scale;
                const radius = (idx === hoveredIndex) ? HOVER_RADIUS : BASE_RADIUS;
                const isHovered = idx === hoveredIndex;

                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fillStyle = isHovered ? 'rgba(0, 255, 0, 0.4)' : 'rgba(0, 255, 0, 0.25)';
                ctx.fill();
                ctx.strokeStyle = isHovered ? '#0f0' : '#0a0';
                ctx.lineWidth = isHovered ? 2 : 1.5;
                ctx.stroke();
            });
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            return { x, y };
        }

        function findHoveredIndex(mouseX, mouseY) {
            for (let i = 0; i < records.length; i++) {
                const rec = records[i];
                const x = rec.x * scale;
                const y = rec.y * scale;
                const dx = mouseX - x;
                const dy = mouseY - y;
                if (dx * dx + dy * dy <= DETECTION_RADIUS * DETECTION_RADIUS) {
                    return i;
                }
            }
            return -1;
        }

        const throttledMouseMove = throttle((e) => {
            if (!imgLoaded) return;
            const pos = getMousePos(e);
            const newHovered = findHoveredIndex(pos.x, pos.y);

            if (newHovered !== hoveredIndex) {
                hoveredIndex = newHovered;
                drawMarkers();
            }
        }, 30);

        canvas.addEventListener('mousemove', throttledMouseMove);

        canvas.addEventListener('mouseleave', () => {
            if (hoveredIndex !== -1) {
                hoveredIndex = -1;
                drawMarkers();
            }
        });

        canvas.addEventListener('click', (e) => {
            if (!imgLoaded) return;
            const pos = getMousePos(e);
            const clickRadius = DETECTION_RADIUS + 10;

            for (let i = 0; i < records.length; i++) {
                const rec = records[i];
                const x = rec.x * scale;
                const y = rec.y * scale;
                const dx = pos.x - x;
                const dy = pos.y - y;
                if (dx * dx + dy * dy <= clickRadius * clickRadius) {
                    let text = `<strong>Координаты: (${Math.round(rec.x)}, ${Math.round(rec.y)})</strong>`;

                    if (rec.was && rec.was !== "Отсутствует") {
                        text += `<br><em>Было:</em> ${escapeHtml(rec.was)}`;
                        if (rec.type_was) text += ` (${escapeHtml(rec.type_was)})`;
                    } else {
                        text += `<br><em>Было:</em> —`;
                    }

                    if (rec.became && rec.became !== "Отсутствует") {
                        text += `<br><em>Стало:</em> ${escapeHtml(rec.became)}`;
                        if (rec.type_became) text += ` (${escapeHtml(rec.type_became)})`;
                    } else {
                        text += `<br><em>Стало:</em> —`;
                    }

                    tooltip.innerHTML = text;
                    tooltip.style.left = (e.clientX + 10) + 'px';
                    tooltip.style.top = (e.clientY + 10) + 'px';
                    tooltip.style.display = 'block';

                    setTimeout(() => {
                        tooltip.style.display = 'none';
                    }, 6000);
                    return;
                }
            }
            tooltip.style.display = 'none';
        });

        // Защита от XSS
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return String(unsafe);
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "<")
                .replace(/>/g, ">")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>